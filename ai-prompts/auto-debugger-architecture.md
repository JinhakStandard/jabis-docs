# JABIS Auto-Debugger 아키텍처

## 전체 시스템 흐름

```
┌──────────────────────────────────────────────────────────────────────────────────────┐
│                              비개발자 개발 환경                                        │
│                                                                                      │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐        │
│  │   Claude    │     │   로컬에서   │     │    Git      │     │  Bitbucket  │        │
│  │ 바이브코딩  │ ──▶ │  코드 작성  │ ──▶ │   Commit    │ ──▶ │    Push     │        │
│  └─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘        │
│                                                                      │               │
└──────────────────────────────────────────────────────────────────────│───────────────┘
                                                                       │
                                                                       ▼
┌──────────────────────────────────────────────────────────────────────────────────────┐
│                                    K3S Cluster                                        │
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                             ArgoCD (자동 배포)                               │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                        │                                             │
│                                        ▼                                             │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                         JABIS Application Pod                                │    │
│  │  ┌───────────────────────────────────────────────────────────────────────┐  │    │
│  │  │                                                                       │  │    │
│  │  │  ┌─────────────────────┐          ┌─────────────────────┐            │  │    │
│  │  │  │   Main Container    │  shared  │   Sidecar Container │            │  │    │
│  │  │  │   (JABIS Node App)  │◀────────▶│   (Log Collector)   │            │  │    │
│  │  │  │                     │  volume  │                     │            │  │    │
│  │  │  │  - React/Node.js    │  /logs   │  - stdout 캡처      │            │  │    │
│  │  │  │  - 비개발자 기능    │          │  - 에러 패턴 감지   │            │  │    │
│  │  │  └─────────────────────┘          │  - 구조화 전송      │            │  │    │
│  │  │                                    └──────────┬──────────┘            │  │    │
│  │  │                                               │                       │  │    │
│  │  └───────────────────────────────────────────────│───────────────────────┘  │    │
│  │                                                  │                          │    │
│  │    Labels:                                       │                          │    │
│  │    - jabis/project-id: "project-abc"            │                          │    │
│  │    - jabis/repo-url: "bitbucket.../repo"        │                          │    │
│  │    - jabis/branch: "main"                       │                          │    │
│  └──────────────────────────────────────────────────│──────────────────────────┘    │
│                                                     │                               │
│                                                     ▼                               │
│  ┌──────────────────────────────────────────────────────────────────────────────┐  │
│  │                          Redis (jabis:errors:stream)                          │  │
│  │                                                                               │  │
│  │   ErrorEvent {                                                                │  │
│  │     id: "err-12345",                                                         │  │
│  │     projectId: "project-abc",                                                │  │
│  │     error: { type: "TypeError", message: "...", stack: "...", file, line },  │  │
│  │     metadata: { repoUrl, branch, commitHash, podName }                       │  │
│  │   }                                                                          │  │
│  └──────────────────────────────────────────────────│───────────────────────────┘  │
│                                                     │                               │
│                                                     ▼                               │
│  ┌──────────────────────────────────────────────────────────────────────────────┐  │
│  │                       Error Detection Service                                 │  │
│  │                                                                               │  │
│  │   ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐           │  │
│  │   │  Redis Stream    │  │   Deduplication  │  │  Task Creator    │           │  │
│  │   │  Consumer        │─▶│   Service        │─▶│                  │           │  │
│  │   │                  │  │                  │  │  - 심각도 분류   │           │  │
│  │   │  - Consumer Grp  │  │  - 해시 비교     │  │  - DB 저장       │           │  │
│  │   │  - 분산 처리     │  │  - 5분 윈도우    │  │  - 알림 전송     │           │  │
│  │   └──────────────────┘  └──────────────────┘  └────────┬─────────┘           │  │
│  │                                                        │                      │  │
│  │                                         ┌──────────────┴──────────────┐       │  │
│  │                                         ▼                             ▼       │  │
│  │                              ┌────────────────┐           ┌────────────────┐  │  │
│  │                              │   PostgreSQL   │           │  WebSocket     │  │  │
│  │                              │                │           │  Notifier      │  │  │
│  │                              │  DebugTask {   │           │                │  │  │
│  │                              │    id,         │           │  - 에이전트 알림 │  │
│  │                              │    status,     │           │  - 실시간 피드  │  │
│  │                              │    attempts,   │           │                │  │  │
│  │                              │    result      │           └───────┬────────┘  │  │
│  │                              │  }             │                   │           │  │
│  │                              └────────────────┘                   │           │  │
│  └───────────────────────────────────────────────────────────────────│───────────┘  │
│                                                                      │              │
│  ┌───────────────────────────────────────────────────────────────────│───────────┐  │
│  │                     Debug Dashboard (Web UI)                       │           │  │
│  │                     jabis-debug.jinhak.com                        │           │  │
│  │                                                                   │           │  │
│  │   ┌──────────────┐  ┌──────────────┐  ┌──────────────┐           │           │  │
│  │   │ 실시간 에러  │  │  태스크 목록  │  │ 에이전트 상태 │           │           │  │
│  │   │    피드      │  │  및 상세     │  │   모니터링   │           │           │  │
│  │   └──────────────┘  └──────────────┘  └──────────────┘           │           │  │
│  └───────────────────────────────────────────────────────────────────│───────────┘  │
│                                                                      │              │
└──────────────────────────────────────────────────────────────────────│──────────────┘
                                                                       │
                                                    WebSocket (wss://)  │
                                                                       │
                                                                       ▼
┌──────────────────────────────────────────────────────────────────────────────────────┐
│                            🖥️  Debug Agent PC (개발팀 PC)                             │
│                                                                                      │
│  ┌──────────────────────────────────────────────────────────────────────────────┐   │
│  │                         JABIS Debug Agent (상주 프로세스)                     │   │
│  │                                                                              │   │
│  │   ┌─────────────────────────────────────────────────────────────────────┐   │   │
│  │   │                        Task Processor                                │   │   │
│  │   │                                                                     │   │   │
│  │   │   1. 태스크 수신 (WebSocket)                                        │   │   │
│  │   │         │                                                           │   │   │
│  │   │         ▼                                                           │   │   │
│  │   │   2. Git 작업                                                       │   │   │
│  │   │      ┌──────────────────────────────────────────────────────┐      │   │   │
│  │   │      │  if (소스 없음)                                       │      │   │   │
│  │   │      │    git clone {repoUrl}                               │      │   │   │
│  │   │      │  else                                                │      │   │   │
│  │   │      │    git fetch && git checkout {branch} && git pull    │      │   │   │
│  │   │      │                                                      │      │   │   │
│  │   │      │  git checkout -b fix/{task-id}                       │      │   │   │
│  │   │      └──────────────────────────────────────────────────────┘      │   │   │
│  │   │         │                                                           │   │   │
│  │   │         ▼                                                           │   │   │
│  │   │   3. AI Orchestra 호출                                              │   │   │
│  │   │      ┌──────────────────────────────────────────────────────┐      │   │   │
│  │   │      │  ai-orchestra fix "에러 메시지"                       │      │   │   │
│  │   │      │    --mode {simple|medium|full}  # 심각도 기반        │      │   │   │
│  │   │      │    --error "스택 트레이스"                            │      │   │   │
│  │   │      │    --context "관련 로그"                              │      │   │   │
│  │   │      │    --auto-fix                                        │      │   │   │
│  │   │      └──────────────────────────────────────────────────────┘      │   │   │
│  │   │         │                                                           │   │   │
│  │   │         ▼                                                           │   │   │
│  │   │   4. 테스트 실행                                                    │   │   │
│  │   │      ┌──────────────────────────────────────────────────────┐      │   │   │
│  │   │      │  npm test && npm run lint                            │      │   │   │
│  │   │      │                                                      │      │   │   │
│  │   │      │  if (통과)                                           │      │   │   │
│  │   │      │    → git commit && git push                          │      │   │   │
│  │   │      │    → Bitbucket PR 생성 or 자동 머지                  │      │   │   │
│  │   │      │  else                                                │      │   │   │
│  │   │      │    → git checkout {branch}  # 롤백                   │      │   │   │
│  │   │      │    → 재시도 (최대 3회)                               │      │   │   │
│  │   │      └──────────────────────────────────────────────────────┘      │   │   │
│  │   │         │                                                           │   │   │
│  │   │         ▼                                                           │   │   │
│  │   │   5. 결과 보고 → 서버로 전송                                        │   │   │
│  │   │                                                                     │   │   │
│  │   └─────────────────────────────────────────────────────────────────────┘   │   │
│  │                                                                              │   │
│  │   ┌─────────────┐                                                           │   │
│  │   │ System Tray │  ● 연결됨 / ○ 연결 끊김 / ◐ 작업 중                      │   │
│  │   └─────────────┘                                                           │   │
│  └──────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│  Workspace: ~/jabis-debug-workspace/                                                │
│  ├── project-abc/                                                                   │
│  ├── project-xyz/                                                                   │
│  └── ...                                                                            │
│                                                                                      │
└──────────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        │ git push
                                        ▼
┌──────────────────────────────────────────────────────────────────────────────────────┐
│                                  Bitbucket Server                                     │
│                                                                                      │
│   fix/{task-id} 브랜치 → PR 생성 or 자동 머지 → main 브랜치                          │
│                                                                                      │
└──────────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        │ Webhook
                                        ▼
                        ┌──────────────────────────────────┐
                        │            ArgoCD                │
                        │       (자동 재배포 트리거)       │
                        └──────────────────────────────────┘
                                        │
                                        ▼
                              🔄 수정된 앱 배포 완료!
```

---

## 데이터 흐름 상세

### 1. 에러 발생 → 감지 흐름

```
JABIS App                Log Collector              Redis                Error Detector
    │                         │                       │                        │
    │  console.error()        │                       │                        │
    │  throw new Error()      │                       │                        │
    │ ───────────────────────▶│                       │                        │
    │                         │                       │                        │
    │                         │  에러 패턴 매칭       │                        │
    │                         │  스택 트레이스 파싱   │                        │
    │                         │                       │                        │
    │                         │  XADD jabis:errors:stream                      │
    │                         │ ──────────────────────▶│                        │
    │                         │                       │                        │
    │                         │                       │  XREADGROUP            │
    │                         │                       │ ───────────────────────▶│
    │                         │                       │                        │
    │                         │                       │                        │  중복 체크
    │                         │                       │                        │  심각도 분류
    │                         │                       │                        │  태스크 생성
    │                         │                       │                        │
```

### 2. 디버깅 → 수정 흐름

```
Error Detector          Debug Agent             AI Orchestra           Bitbucket
    │                        │                       │                     │
    │  WebSocket: NEW_TASK   │                       │                     │
    │ ───────────────────────▶│                       │                     │
    │                        │                       │                     │
    │                        │  git clone/pull       │                     │
    │                        │ ──────────────────────────────────────────▶│
    │                        │                       │                     │
    │                        │  ai-orchestra fix     │                     │
    │                        │ ──────────────────────▶│                     │
    │                        │                       │                     │
    │                        │                       │  코드 분석          │
    │                        │                       │  수정 실행          │
    │                        │                       │  테스트             │
    │                        │                       │                     │
    │                        │◀──────────────────────│                     │
    │                        │  수정 결과            │                     │
    │                        │                       │                     │
    │                        │  git commit & push    │                     │
    │                        │ ──────────────────────────────────────────▶│
    │                        │                       │                     │
    │                        │  PR 생성 (또는 머지)  │                     │
    │                        │ ──────────────────────────────────────────▶│
    │                        │                       │                     │
    │  TASK_COMPLETED        │                       │                     │
    │◀───────────────────────│                       │                     │
    │                        │                       │                     │
```

---

## 심각도별 처리 전략

| 심각도 | 에러 유형 | AI Orchestra 모드 | 자동 머지 | 타임아웃 |
|--------|----------|------------------|----------|---------|
| **Critical** | Uncaught Exception, 서버 크래시 | Full | 테스트 통과 시 O | 30분 |
| **Error** | TypeError, ReferenceError, 4xx/5xx | Medium | 신뢰도 0.9+ | 15분 |
| **Warning** | Deprecation, 경고 로그 | Simple | X (PR만) | 5분 |

---

## 보안 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           보안 레이어                                    │
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                    Debug Agent 인증                                │ │
│  │                                                                   │ │
│  │   1. Agent 등록 시 고유 API Key 발급                              │ │
│  │   2. WebSocket 연결 시 JWT 토큰 검증                              │ │
│  │   3. Agent별 접근 가능 프로젝트 제한                              │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                    자동 수정 제한                                  │ │
│  │                                                                   │ │
│  │   수정 불가 파일/디렉토리:                                        │ │
│  │   - src/auth/*                                                    │ │
│  │   - src/security/*                                                │ │
│  │   - *.config.js                                                   │ │
│  │   - package.json (dependencies 제외)                              │ │
│  │                                                                   │ │
│  │   일일 자동 수정 제한: 프로젝트당 10회                            │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                    감사 로그                                       │ │
│  │                                                                   │ │
│  │   - 모든 자동 수정 기록 (before/after diff)                       │ │
│  │   - Agent 접근 로그                                               │ │
│  │   - 롤백 히스토리 90일 보관                                       │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 구현 로드맵

```
Week 1                    Week 2                    Week 3
├────────────────────────┼────────────────────────┼────────────────────────┤
│                        │                        │                        │
│  Log Collector         │  Error Detector        │  Debug Agent Core      │
│  Sidecar 개발          │  Service 개발          │  개발                  │
│                        │                        │                        │
│  K3S Deployment        │  Redis Stream          │  Git Manager           │
│  YAML 작성             │  Consumer              │  구현                  │
│                        │                        │                        │
├────────────────────────┴────────────────────────┴────────────────────────┤
                                    │
Week 4                    Week 5                    Week 6
├────────────────────────┼────────────────────────┼────────────────────────┤
│                        │                        │                        │
│  AI Orchestra          │  Dashboard             │  통합 테스트           │
│  통합                  │  개발                  │                        │
│                        │                        │  Helm Chart            │
│  Bitbucket             │  프로젝트 설정         │  배포                  │
│  PR 생성               │  UI                    │                        │
│                        │                        │  문서화                │
└────────────────────────┴────────────────────────┴────────────────────────┘
```
